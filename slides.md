---
# You can also start simply with 'default'
theme: default
# random image from a curated Unsplash collection by Anthony
# like them? see https://unsplash.com/collections/94734566/slidev
background: ./images/hwl.webp
# some information about your slides (markdown enabled)
title: Reverse Engineering Denuvo in Hogwarts Legacy
class: text-center
# https://sli.dev/features/drawing
drawings:
  persist: false
# slide transition: https://sli.dev/guide/animations.html#slide-transitions
transition: fade-out
# enable MDC Syntax: https://sli.dev/features/mdc
mdc: true
# open graph
# seoMeta:
#  ogImage: https://cover.sli.dev
---

<style scoped>
.slidev-layout {
    padding: 0px;
}

h1 {
  color: rgba(255, 255, 255, 0.95);
  text-shadow: 0px 0px 0.3em rgba(0, 0, 0, 0.381);
  box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
}

h1 img.denuvo-logo {
  display: inline;
  transform: translateY(-0.05em);
  width: 180px;
  filter: invert() drop-shadow(0px 0px 0.1em rgba(0, 0, 0, 0.575));
}

h1 img.hwl-logo {
  display: inline;
  transform: translateY(-0.2em);
  width: 220px;
  filter: invert() drop-shadow(0px 0px 0.1em rgba(0, 0, 0, 0.575));
}
</style>
<h1 class="mt--70 backdrop-blur-xl p-9 text-shadow-3xl">
Reverse Engineering
<br>
<img class="denuvo-logo" src="./images/denuvo-logo.png" /> in <img class="hwl-logo" src="./images/hwl-logo.png" />
</h1>

---

# Who am I?

<div class="flex">

- Maurice Heumann
- Cybersecurity Engineer @ Thales
- Cracked & modded Call of Duty games (BOIII, XLabs)
- Twitter: @momo5502

<div class="flex-1 text-center">
<img class="rounded-2xl w-70 m-auto" src="./images/me.png" />
</div>
</div>

---

# Agenda

- Understanding Denuvo
- Cracking the Game
- Performance Reasoning

---
layout: center
---

# Understanding Denuvo

---

# What is Denuvo?

<div class="flex" m="t-2">

<div>

- **Anti-tamper solution** by Irdeto
- **Not a DRM itself** - protects existing DRM systems
  - Steam, Origin, Epic Games Store, etc.
- **Used by major publishers**: EA, Ubisoft, Square Enix, Capcom
- **Controversial**: Loved by publishers, hated by pirates

‚Üí Strongest Game Protection to date

</div>

<div class="text-center flex-1">

```mermaid
flowchart BT
    game(üéÆ Game Executable)
    drm("üîí DRM Layer (Steam)")
    denuvo(üõ°Ô∏è Denuvo Anti-Tamper)
    drm --> game
    denuvo --> drm
```

</div>
</div>

---
clicks: 13
---

# How does Denuvo work?

<v-clicks every="0.5">

1. Hardware fingerprint is generated ‚Üí Computername + Username + ...
2. Steam ticket generation ‚Üí Proof of game ownership
3. Fingerprint & Steam ticket is sent to Denuvo server
4. Server validates steam ticket ‚Üí Do you really own the game?
5. Server generates Denuvo token for the fingerprint
6. Game runs with Denuvo token

</v-clicks>

<div class="flex mt-6 text-shadow-xl"
  v-motion
  :initial="{ x: 0, y: 300 }"
  :click-1="{ y: 0 }"
>
<div class="border-3 border-lime p-4 rounded-lg">
üéÆ Game
<div class="border-3 border-red-600 rounded-md p-1 m-2"
  v-motion
  :initial="{ x: 0, y: 300 }"
  :click-3="{ y: 0 }"
  :click-7="{ x: 660 }"
  >
  üîç Fingerprint
</div>

<div class="border-3 border-red-600 rounded-md p-1 m-2"
  v-motion
  :initial="{ x: 0, y: 300 }"
  :click-5="{ y: 0 }"
  :click-7="{ x: 660 }"
>
  üéüÔ∏è Steam Ticket
</div>
<div
  class="absolute font-size-[1.2em]"
  v-motion
  :initial="{ x: 673, y: 300 }"
  :click-9="{ x: 673, y: -43 }"
>‚úÖ</div>
<div class="border-3 rounded-md p-1 m-2 opacity-0"
>
  üîë Denuvo Token
</div>
</div>

<div class="flex-1">
</div>

<div class="border-3 border-sky-500 p-4 rounded-lg">
üåê Denuvo Server

<div class="border-3 rounded-md p-1 m-2 opacity-0"
  >
  üîç Fingerprint
</div>

<div class="border-3 rounded-md p-1 m-2 opacity-0">
  üéüÔ∏è Steam Ticket
</div>

<div class="border-3 border-yellow rounded-md p-1 m-2"
  v-motion
  :initial="{ x: 0, y: 300 }"
  :click-11="{ y: 0 }"
  :click-13="{ x: -660 }"
>
  üîë Denuvo Token
</div>
</div>
</div>

---

# What is the fingerprint?

&nbsp;

Collection of features that uniquely identify the PC:

- Computer name
- Username
- CPU Identifiers
- OS Identifiers
- ...

---

# What is a Denuvo token?

- Blob generated by the denuvo server
- Matches the fingerprint
- Stored on your drive (only requested by the server if necessary)
  - C:\\Program Files (x86)\\Steam\\userdata\\<span class="text-lime-500">100691295</span>\\<span class="text-yellow-500">990080</span>\\<span class="text-sky-500">94149734061</span>
- Blob decodes to an xml file:

```xml {*|1|2|3}
<ai>990080</ai>                                         <!-- App ID: Hogwarts Legacy -->
<ui>5f6d000601001001</ui>                               <!-- Steam User ID -->
<gt>CQBFR0aGA0eM2o ... eXYYW1BGYPLhA_THfJVDAgJ2c=</gt>  <!-- Encoded game token data -->
```

‚Üí no idea what the game token data is ¬Ø\\\_(„ÉÑ)\_/¬Ø

---

# What is the Denuvo token used for?

- Game only runs with the token matching the PC's fingerprint
- Game reads many fingerprint values at runtime
- Values are probably used to encrypt parts of the game data at runtime
- Token contains information to decrypt them

‚Üí Mostly guessed, I didn't reverse engineer that in depth

**Invalid Token:**
<img src="./images/bad-token.png" class="mt-2 rounded-lg">

---

# What makes Denuvo so strong?

&nbsp;

**Custom Protection Per Game:**

- Each game is unique
- Different fingerprints, patterns, validation
- No generic crack possible

**Advanced Code Protection:**

- No traditional packing ‚Üí code remains accessible
- **Code virtualization** ‚Üí critical sections run in custom VM
- **Tight integration** ‚Üí Denuvo is mixed into game logic
- **Thousands of checks** ‚Üí validations everywhere

---
layout: center
---

# Cracking the Game

---

# How to approach this?

<v-clicks>

**Two possibilities:**

1. Remove Denuvo from the Game ‚Üí üõë insane
2. Patch Fingerprint to mimic other PC ‚Üí ‚úÖ

**Fingerprint Patching**

- Make Game think it runs on different PC
- Hardcode token for that PC

‚Üí Find all fingerprints and patch every use in the game

</v-clicks>

---

# How to find fingerprint features?

- Denuvo must **communicate** with OS, Hardware, Filesystem, ...
  - Game needs information from somewhere

Three main ways of communication:

- API calls
- Special instructions (CPUID, Syscall, ...)
- Reading Memory

‚Üí We need a way to easily analyze, instrument and intercept all 3

---

# Userspace Emulation

- Simulate CPU, Memory & OS in Software

Emulator can:

- instrument all API calls
- trace all instructions
- intercept every memory access

What the emulator can not: emulate graphics -> it won't be able to fully boot into the game
luckily:
Denuvo has two phases:

1. collection phase, before it talks to the server
2. runtime, when the game runs, after server communication

-> emulation analysis only needs to run until the server communication.

---

# 1. API calls

**How to trace them?**

- Breakpoint on every exported function of every DLL
  - super cheap in the emulator

<img class="mt-4 rounded-lg border-2 border-yellow" src="./images/api-calls.png" />

---

# 1. API calls

- GetVolumeInformationW
- GetUserNameW
- GetComputerNameW
- CryptGetProvParam
- CryptAcquireContextA
- CryptAcquireContextW
- CryptEnumProvidersW
- ExpandEnvironmentStringsA &rarr; %COMPUTERNAME%

---

# 1. API calls

**How to patch them?**

- Denuvo has no integrity checks on API calls
- just hook all API calls and return constant values

---

# 2. PEB

**How to trace memory?**

- Intercept all memory access in emulator
- Skip uninteresting access (stack, heap, loaded modules, ...)

<img class="mt-4 rounded-lg border-2 border-lime" src="./images/peb.png" />

---

# 2. PEB

- OSMajorVersion
- OSMinorVersion
- NumberOfProcessors
- ImageSubsystemMajorVersion
- ImageSubsystemMinorVersion
- ProcessParameters -> Environment
  - Denuvo reads random values in the environment variables
  - Offsets: 0x74, 0x123, 0x1d8, 0x291

---

# 2. PEB

**How to patch them?**

- unprotect memory and overwrite with constant values
- can have undesired side effects ‚Üí don't care, it's just a POC ¬Ø\\\_(„ÉÑ)\_/¬Ø

---
transition: slide-up
---

# 3. CPUID

<img class="mt-4 rounded-lg border-2 border-sky" src="./images/cpuid.png" />

- 1
- 0x80000002
- 0x80000003
- 0x80000004

- load hypervisor -> custom CPUID vmexit handler for hogwarts legacy
- hides other features -> xgetbv -> patch leaf
- other features conditionally active that i might not have needed to patch

---
transition: slide-down
---

# What is a hypervisor?

---

# 4. KUSER_SHARED_DATA

<img class="mt-4 rounded-lg border-2 border-lime" src="./images/kusd.png" />

- NtProductType
- ActiveProcessorCount
- SuiteMask
- ProductTypeIsValid
- NtMajorVersion
- NtMinorVersion
- NtBuildNumber
- ProcessorFeatures
- NumberOfPhysicalPages

---

--> hard to patch

- find all places -> ideally HWBP + exception handler
- non-linear stack -> wrote a debugger that attaches to the game and traces using HWBP
- no guarantee i'll ever have all locations

- dynamic hook creation
- redirect memory load to fake memory region
- disassemble all load instruction
- analyze and replicate memory source (scale-index-base)
- replicate instruction (xor, add, mov, ...)

---
transition: slide-up
---

# 5. Inline syscalls

<img class="mt-4 rounded-lg border-2 border-sky" src="./images/syscall.png" />

NtQuerySystemInformation &rarr; SystemBasicInformation

ntdll exports are parsed to find syscall ID

--> Inline syscalls

- KUSD approach doesn't work -> mini integrity checks on instructions
  - instruction bytes are read and computed into other calculations
  - bytes need to stay intact
    --> hypervisor + ept hooks -> redirect syscalls to custom handler that replays original data
    --> syscall hooks would've also worked, but my hypervisor couldn't do that at the time

---
transition: slide-down
---

# Hypervisor -> shadow hooking

---

# The last one...

Took me 3 months to find...

---

# 6. Import integrity

- --> Advapi32.dll
- addresses of these values in IAT
- changing them invalidates the token, so aslr changes on a reboot might invalidate it.

* CryptAcquireContextA
* CryptGetProvParam
* GetUserNameW
* GetVolumeInformationW

--> insanely hard to find. why?
-> regular memory access, nothing special
-> game reads import table all the time, nothing suspicious
-> usually import is used for execution, not in denuvo case

--> simple to patch

- trampolinee at fixed VA that redirects to the original value
- requires that the VA is available, which it should be

---

# It's running...

<img src="./images/running.png" />

---

# What does that leave us with?

--> game runs, but semi stable - why?
-> sampling KUSD may miss values
-> patching CPUID can destabilize system
-> overwriting PEB can also destabilize

--> 2k hooks. can we do something with that?
-> we can analyze when the hooks are triggered to see in which situations the game executes denuvo code --> performance reasoning

---
layout: center
---

# Performance Reasoning

---

# Performance Reasoning

- For me, impossible to make detailed measurements --> I would need game without denuvo and with denuvo
- denuvo changes a lot, each game is protected differently, even different versions of the game, each integration is different.
- denuvo has a dedicated team that performs integration into games
- prior analysis mostly meaningless, has to be looked at for each game invidivually

* each of my 2000 hooks prints when it's called
* if no print occurs, no denuvo verification code runs --> very likely no possibility of performance impacts
* video a few prints during normal gameplay
* lots of prints during transition/loadscreen

---

# Performance Reasoning

<Youtube id="6JriEmiZ1t0" width="720" height="405" />

---

# Summary
